import * as React from 'react'
import { useForm, type FieldValues } from 'react-hook-form'
import { zodResolver } from '@hookform/resolvers/zod'
import { type ZodSchema } from 'zod'
import { cn } from '@/lib/utils'
import { Button } from '@/components/ui/button'
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
import { Badge } from '@/components/ui/badge'
import { Separator } from '@/components/ui/separator'
import { Alert, AlertDescription } from '@/components/ui/alert'
import { 
  Dialog, 
  DialogContent, 
  DialogDescription, 
  DialogHeader, 
  DialogTitle, 
  DialogTrigger 
} from '@/components/ui/dialog'
import { 
  DropdownMenu, 
  DropdownMenuContent, 
  DropdownMenuItem, 
  DropdownMenuTrigger 
} from '@/components/ui/dropdown-menu'
import { LoadingSpinner } from '@/components/ui/loading-spinner'
import { useFormSubmission, useFormDrafts, useFormAnalytics } from '@/hooks/use-form-submission'
import { EnhancedFormField, type FormFieldConfig } from './enhanced-form-field'
import { 
  Save, 
  RotateCcw, 
  RefreshCw, 
  CheckCircle2, 
  AlertCircle, 
  Clock, 
  FileText,
  Trash2,
  Download
} from 'lucide-react'
import { format } from 'date-fns'

export interface FormSubmissionHandlerProps<T extends FieldValues> {
  schema: ZodSchema<T>
  fields: FormFieldConfig[]
  defaultValues?: Partial<T>
  onSubmit: (data: T) => Promise<any>
  title?: string
  description?: string
  submitText?: string
  resetText?: string
  className?: string
  showDrafts?: boolean
  showAnalytics?: boolean
  autoSave?: boolean
  retryAttempts?: number
  successMessage?: string | ((data: T) => string)
  errorMessage?: string | ((error: Error) => string)
  resetOnSuccess?: boolean
}

export function FormSubmissionHandler<T extends FieldValues>({
  schema,
  fields,
  defaultValues,
  onSubmit,
  title = 'Form',
  description,
  submitText = 'Submit',
  resetText = 'Reset',
  className,
  showDrafts = true,
  showAnalytics = false,
  autoSave = true,
  retryAttempts = 2,
  successMessage = 'Form submitted successfully!',
  errorMessage = 'Failed to submit form. Please try again.',
  resetOnSuccess = false,
}: FormSubmissionHandlerProps<T>) {
  const [showDraftDialog, setShowDraftDialog] = React.useState(false)
  const [showAnalyticsDialog, setShowAnalyticsDialog] = React.useState(false)

  const form = useForm<T>({
    resolver: zodResolver(schema),
    defaultValues,
    mode: 'onChange',
  })

  const { control, reset, formState: { isDirty, isValid, errors } } = form

  // Form submission handling
  const submission = useFormSubmission(form, onSubmit, {
    successMessage,
    errorMessage,
    resetOnSuccess,
    retryAttempts,
    showToast: true,
    analytics: {
      trackSubmission: true,
      trackSuccess: true,
      trackError: true,
      eventName: title.toLowerCase().replace(/\s+/g, '_'),
    },
  })

  // Draft management
  const drafts = useFormDrafts(form, title.toLowerCase().replace(/\s+/g, '-'), {
    autoSave,
    saveDelay: 1000,
    maxDrafts: 5,
    onDraftSaved: (draft) => {
      console.log('Draft saved:', draft)
    },
    onDraftLoaded: (draft) => {
      console.log('Draft loaded:', draft)
    },
  })

  // Analytics tracking
  const analytics = useFormAnalytics(title)

  // Track form interactions
  React.useEffect(() => {
    const subscription = form.watch((_, { name }) => {
      if (name) {
        analytics.trackFieldInteraction(name)
      }
    })
    return () => subscription.unsubscribe()
  }, [form, analytics])

  // Track validation errors
  React.useEffect(() => {
    Object.keys(errors).forEach(fieldName => {
      analytics.trackValidationError(fieldName)
    })
  }, [errors, analytics])

  // Track submission attempts
  React.useEffect(() => {
    if (submission.isSubmitting) {
      analytics.trackSubmitAttempt()
    }
  }, [submission.isSubmitting, analytics])

  // Track completion
  React.useEffect(() => {
    if (submission.isSuccess) {
      analytics.trackCompletion()
    }
  }, [submission.isSuccess, analytics])

  const handleReset = () => {
    reset(defaultValues)
    submission.resetState()
  }

  const exportFormData = () => {
    const data = form.getValues()
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' })
    const url = URL.createObjectURL(blob)
    const a = document.createElement('a')
    a.href = url
    a.download = `${title.toLowerCase().replace(/\s+/g, '-')}-data.json`
    document.body.appendChild(a)
    a.click()
    document.body.removeChild(a)
    URL.revokeObjectURL(url)
  }

  const formatDraftTimestamp = (timestamp: Date) => {
    return format(new Date(timestamp), 'MMM dd, yyyy HH:mm')
  }

  return (
    <Card className={cn('w-full', className)}>
      <CardHeader>
        <div className="flex items-center justify-between">
          <div>
            <CardTitle className="flex items-center space-x-2">
              <span>{title}</span>
              {submission.isSuccess && (
                <Badge variant="default" className="bg-green-500">
                  <CheckCircle2 className="h-3 w-3 mr-1" />
                  Success
                </Badge>
              )}
              {submission.isError && (
                <Badge variant="destructive">
                  <AlertCircle className="h-3 w-3 mr-1" />
                  Error
                </Badge>
              )}
            </div>
            
            <div className="flex items-center space-x-2 mt-2">
              {/* Draft Status */}
              {autoSave && (
                <div className="flex items-center space-x-1 text-xs text-muted-foreground">
                  {drafts.draftStatus === 'saving' && (
                    <>
                      <LoadingSpinner className="h-3 w-3" />
                      <span>Saving...</span>
                    </>
                  )}
                  {drafts.draftStatus === 'saved' && (
                    <>
                      <Save className="h-3 w-3 text-green-500" />
                      <span>Draft saved</span>
                    </>
                  )}
                </div>
              )}

              {/* Action Buttons */}
              <div className="flex items-center space-x-1">
                {showDrafts && drafts.availableDrafts.length > 0 && (
                  <Dialog open={showDraftDialog} onOpenChange={setShowDraftDialog}>
                    <DialogTrigger asChild>
                      <Button variant="ghost" size="sm">
                        <FileText className="h-4 w-4 mr-1" />
                        Drafts ({drafts.availableDrafts.length})
                      </Button>
                    </DialogTrigger>
                    <DialogContent>
                      <DialogHeader>
                        <DialogTitle>Saved Drafts</DialogTitle>
                        <DialogDescription>
                          Load a previously saved draft or delete old drafts
                        </DialogDescription>
                      </DialogHeader>
                      <div className="space-y-2 max-h-60 overflow-y-auto">
                        {drafts.availableDrafts.map((draft) => (
                          <div
                            key={draft.id}
                            className="flex items-center justify-between p-3 border rounded-md"
                          >
                            <div>
                              <p className="text-sm font-medium">
                                {formatDraftTimestamp(draft.timestamp)}
                              </p>
                              <p className="text-xs text-muted-foreground">
                                Auto-saved draft
                              </p>
                            </div>
                            <div className="flex items-center space-x-1">
                              <Button
                                variant="ghost"
                                size="sm"
                                onClick={() => {
                                  drafts.loadDraft(draft.id)
                                  setShowDraftDialog(false)
                                }}
                              >
                                Load
                              </Button>
                              <Button
                                variant="ghost"
                                size="sm"
                                onClick={() => drafts.deleteDraft(draft.id)}
                              >
                                <Trash2 className="h-4 w-4" />
                              </Button>
                            </div>
                          </div>
                        ))}
                      </div>
                      {drafts.availableDrafts.length > 0 && (
                        <Button
                          variant="outline"
                          onClick={() => {
                            drafts.clearAllDrafts()
                            setShowDraftDialog(false)
                          }}
                          className="w-full"
                        >
                          Clear All Drafts
                        </Button>
                      )}
                    </DialogContent>
                  </Dialog>
                )}

                {showAnalytics && (
                  <Dialog open={showAnalyticsDialog} onOpenChange={setShowAnalyticsDialog}>
                    <DialogTrigger asChild>
                      <Button variant="ghost" size="sm">
                        <Clock className="h-4 w-4 mr-1" />
                        Analytics
                      </Button>
                    </DialogTrigger>
                    <DialogContent>
                      <DialogHeader>
                        <DialogTitle>Form Analytics</DialogTitle>
                        <DialogDescription>
                          Insights about form usage and performance
                        </DialogDescription>
                      </DialogHeader>
                      <div className="space-y-4">
                        {(() => {
                          const metrics = analytics.getFormMetrics()
                          return (
                            <>
                              <div className="grid grid-cols-2 gap-4">
                                <div className="p-3 border rounded-md">
                                  <p className="text-sm font-medium">Time Spent</p>
                                  <p className="text-2xl font-bold">{metrics.timeSpent}s</p>
                                </div>
                                <div className="p-3 border rounded-md">
                                  <p className="text-sm font-medium">Submit Attempts</p>
                                  <p className="text-2xl font-bold">{metrics.submitAttempts}</p>
                                </div>
                              </div>
                              
                              <div>
                                <p className="text-sm font-medium mb-2">Field Interactions</p>
                                <div className="space-y-1">
                                  {Object.entries(metrics.fieldInteractions).map(([field, count]) => (
                                    <div key={field} className="flex justify-between text-sm">
                                      <span>{field}</span>
                                      <span>{count} interactions</span>
                                    </div>
                                  ))}
                                </div>
                              </div>

                              {Object.keys(metrics.validationErrors).length > 0 && (
                                <div>
                                  <p className="text-sm font-medium mb-2">Validation Errors</p>
                                  <div className="space-y-1">
                                    {Object.entries(metrics.validationErrors).map(([field, count]) => (
                                      <div key={field} className="flex justify-between text-sm">
                                        <span>{field}</span>
                                        <span>{count} errors</span>
                                      </div>
                                    ))}
                                  </div>
                                </div>
                              )}
                            </>
                          )
                        })()}
                      </div>
                    </DialogContent>
                  </Dialog>
                )}

                <DropdownMenu>
                  <DropdownMenuTrigger asChild>
                    <Button variant="ghost" size="sm">
                      <Download className="h-4 w-4" />
                    </Button>
                  </DropdownMenuTrigger>
                  <DropdownMenuContent>
                    <DropdownMenuItem onClick={exportFormData}>
                      Export Form Data
                    </DropdownMenuItem>
                    <DropdownMenuItem onClick={drafts.saveDraft}>
                      Save Draft Manually
                    </DropdownMenuItem>
                  </DropdownMenuContent>
                </DropdownMenu>
              </div>
            </div>
          </div>
        </div>
        
        {description && <CardDescription>{description}</CardDescription>}
      </CardHeader>

      <CardContent className="space-y-6">
        {/* Status Messages */}
        {submission.isSuccess && (
          <Alert className="border-green-200 bg-green-50 dark:bg-green-950">
            <CheckCircle2 className="h-4 w-4 text-green-600" />
            <AlertDescription className="text-green-800 dark:text-green-100">
              {typeof successMessage === 'function' 
                ? successMessage(form.getValues()) 
                : successMessage}
            </AlertDescription>
          </Alert>
        )}

        {submission.isError && (
          <Alert variant="destructive">
            <AlertCircle className="h-4 w-4" />
            <AlertDescription>
              {typeof errorMessage === 'function' 
                ? errorMessage(submission.error!) 
                : errorMessage}
              {submission.retryCount > 0 && (
                <span className="block mt-1 text-sm">
                  Retry attempt {submission.retryCount} of {retryAttempts}
                </span>
              )}
            </AlertDescription>
          </Alert>
        )}

        {/* Form Fields */}
        <form onSubmit={submission.submit} className="space-y-4">
          {fields.map((field) => (
            <EnhancedFormField
              key={field.name}
              {...field}
              name={field.name}
              control={control}
              disabled={submission.isSubmitting}
            />
          ))}

          <Separator />

          {/* Form Actions */}
          <div className="flex items-center justify-between pt-4">
            <div className="flex items-center space-x-2">
              <Button
                type="button"
                variant="outline"
                onClick={handleReset}
                disabled={submission.isSubmitting || !isDirty}
              >
                <RotateCcw className="h-4 w-4 mr-2" />
                {resetText}
              </Button>

              {submission.isError && (
                <Button
                  type="button"
                  variant="outline"
                  onClick={submission.retry}
                  disabled={submission.isSubmitting}
                >
                  <RefreshCw className="h-4 w-4 mr-2" />
                  Retry
                </Button>
              )}
            </div>

            <div className="flex items-center space-x-2">
              {submission.submitCount > 0 && (
                <span className="text-sm text-muted-foreground">
                  Attempts: {submission.submitCount}
                </span>
              )}
              
              <Button
                type="submit"
                disabled={submission.isSubmitting || !isValid}
                className="min-w-[120px]"
              >
                {submission.isSubmitting ? (
                  <>
                    <LoadingSpinner className="mr-2 h-4 w-4" />
                    Submitting...
                  </>
                ) : (
                  submitText
                )}
              </Button>
            </div>
          </div>
        </form>

        {/* Submission Statistics */}
        {submission.submitCount > 0 && (
          <div className="pt-4 border-t">
            <div className="flex items-center justify-between text-sm text-muted-foreground">
              <span>
                Last submission: {submission.lastSubmitTime?.toLocaleTimeString()}
              </span>
              <span>
                Success rate: {submission.isSuccess ? '100%' : '0%'}
              </span>
            </div>
          </div>
        )}
      </CardContent>
    </Card>
  )
}